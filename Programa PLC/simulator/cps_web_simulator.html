<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPS-001 Simulator - PULL SYSTEM v3</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            font-family: 'Consolas', 'Courier New', monospace;
            background: #1a1a2e;
            color: #eee;
            height: 100vh;
            overflow: hidden;
        }
        .container { 
            height: 100vh; 
            display: flex; 
            flex-direction: column;
            padding: 15px 25px;
        }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 8px 0;
        }
        .header h1 { color: #00d4ff; font-size: 24px; }
        .header h2 { color: #888; font-size: 14px; }
        
        .main-content {
            display: flex;
            flex: 1;
            gap: 20px;
            min-height: 0;
        }
        
        .left-panel {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .right-panel {
            width: 320px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .status-bar {
            display: flex; justify-content: space-around;
            background: #2a2a4a; padding: 12px; border-radius: 8px;
        }
        .status-item { text-align: center; }
        .status-label { font-size: 11px; color: #888; }
        .status-value { font-size: 18px; font-weight: bold; }
        .status-ok { color: #00ff88; }
        .status-error { color: #ff4444; }
        .status-warning { color: #ffaa00; }
        
        .groups-container {
            display: flex; 
            flex-direction: column; 
            flex: 1;
            justify-content: space-evenly;
        }
        .group-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .group {
            background: #2a2a4a; border-radius: 8px; padding: 12px 15px;
            display: flex; align-items: center; gap: 15px;
            flex: 1;
        }
        .group-info { width: 160px; }
        .group-name { font-weight: bold; color: #00d4ff; font-size: 16px; }
        .group-desc { font-size: 12px; color: #888; }
        .group-lot { font-size: 12px; color: #ffaa00; margin-top: 2px; }
        
        .progress-bar {
            flex: 1; height: 35px; background: #1a1a2e;
            border-radius: 6px; overflow: hidden; position: relative;
        }
        .progress-fill {
            height: 100%; 
            transition: width 0.1s ease;
        }
        .progress-fill.lot-a { background: linear-gradient(90deg, #00d4ff, #0088ff); }
        .progress-fill.lot-b { background: linear-gradient(90deg, #ff8800, #ffaa00); }
        .progress-fill.lot-c { background: linear-gradient(90deg, #00ff88, #00cc66); }
        .progress-fill.lot-d { background: linear-gradient(90deg, #ff44aa, #ff88cc); }
        .progress-fill.empty { background: transparent; }
        .progress-text {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold; font-size: 16px;
        }
        
        .gate {
            width: 90px; text-align: center; padding: 8px;
            border-radius: 6px; font-weight: bold; font-size: 11px;
        }
        .gate-open { background: #00ff88; color: #000; }
        .gate-closed { background: #444; color: #888; }
        
        .arrow { 
            color: #00d4ff; font-size: 18px; 
            text-align: center;
            padding: 2px 0;
            margin-left: 80px;
        }
        
        .controls {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .btn {
            padding: 18px 10px; border: none; border-radius: 8px;
            font-family: inherit; font-size: 14px; font-weight: bold;
            cursor: pointer; transition: all 0.2s;
        }
        .btn:hover { transform: scale(1.02); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-scan { background: #00d4ff; color: #000; }
        .btn-start { background: #00ff88; color: #000; }
        .btn-estop { background: #ff4444; color: #fff; }
        .btn-reset { background: #888; color: #fff; }
        
        .indicators {
            display: flex; justify-content: space-around;
            background: #2a2a4a; padding: 12px; border-radius: 8px;
        }
        .indicator { display: flex; align-items: center; gap: 6px; font-size: 12px; }
        .light {
            width: 18px; height: 18px; border-radius: 50%;
            background: #333; border: 2px solid #555;
        }
        .light-green { background: #00ff88; box-shadow: 0 0 10px #00ff88; }
        .light-yellow { background: #ffaa00; box-shadow: 0 0 10px #ffaa00; }
        .light-blue { background: #00d4ff; box-shadow: 0 0 10px #00d4ff; }
        
        .log {
            background: #1a1a2e; border: 1px solid #333;
            border-radius: 8px; padding: 10px;
            flex: 1; overflow-y: auto; min-height: 0;
        }
        .log-entry { font-size: 11px; padding: 3px 0; border-bottom: 1px solid #222; }
        .log-time { color: #00d4ff; }
        
        .legend {
            display: flex; justify-content: center; gap: 20px;
            font-size: 12px; padding: 8px 0;
            background: #2a2a4a; border-radius: 8px;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-color { width: 20px; height: 12px; border-radius: 3px; }
        
        .keyboard-hint {
            text-align: center; color: #666; font-size: 11px;
        }
        
        .queue-info {
            background: #2a2a4a; padding: 10px 12px; border-radius: 8px;
            text-align: center; font-size: 13px;
        }
        .queue-info span { color: #ffaa00; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üåΩ CPS-001 CORN PROCESSING</h1>
            <h2>v3.1 PULL SYSTEM</h2>
        </div>
        
        <div class="main-content">
            <!-- Left Panel: Groups -->
            <div class="left-panel">
                <div class="status-bar">
                    <div class="status-item">
                        <div class="status-label">SYSTEM</div>
                        <div id="sysStatus" class="status-value status-ok">READY</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">E-STOP</div>
                        <div id="estopStatus" class="status-value status-ok">OK</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">LOTS</div>
                        <div id="lotsCount" class="status-value">0</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">NEXT</div>
                        <div id="nextLot" class="status-value status-warning">---</div>
                    </div>
                </div>
                
                <div class="groups-container">
                    <!-- Group 1 -->
                    <div class="group-row">
                        <div class="group">
                            <div class="group-info">
                                <div class="group-name">G1: FEEDER</div>
                                <div class="group-desc">Manual Load</div>
                                <div id="lot1" class="group-lot">Empty</div>
                            </div>
                            <div class="progress-bar">
                                <div id="progress1" class="progress-fill empty" style="width: 0%"></div>
                                <div id="progressText1" class="progress-text">0%</div>
                            </div>
                            <div id="gate1" class="gate gate-closed">MAT GATE<br>CLOSED</div>
                        </div>
                    </div>
                    <div class="arrow">‚ñº</div>
                    
                    <!-- Group 2 -->
                    <div class="group-row">
                        <div class="group">
                            <div class="group-info">
                                <div class="group-name">G2: SHELLER</div>
                                <div class="group-desc">+ Air Conveyor</div>
                                <div id="lot2" class="group-lot">Empty</div>
                            </div>
                            <div class="progress-bar">
                                <div id="progress2" class="progress-fill empty" style="width: 0%"></div>
                                <div id="progressText2" class="progress-text">0%</div>
                            </div>
                            <div id="gate2" class="gate gate-closed">ASP GATE<br>CLOSED</div>
                        </div>
                    </div>
                    <div class="arrow">‚ñº</div>
                    
                    <!-- Group 3 -->
                    <div class="group-row">
                        <div class="group">
                            <div class="group-info">
                                <div class="group-name">G3: ASPIRATOR</div>
                                <div class="group-desc">Hopper ‚Üí VMEK</div>
                                <div id="lot3" class="group-lot">Empty</div>
                            </div>
                            <div class="progress-bar">
                                <div id="progress3" class="progress-fill empty" style="width: 0%"></div>
                                <div id="progressText3" class="progress-text">0%</div>
                            </div>
                            <div id="gate3" class="gate gate-closed">R12 GATE<br>CLOSED</div>
                        </div>
                    </div>
                    <div class="arrow">‚ñº</div>
                    
                    <!-- Group 4 -->
                    <div class="group-row">
                        <div class="group">
                            <div class="group-info">
                                <div class="group-name">G4: R12</div>
                                <div class="group-desc">Seed Treater</div>
                                <div id="lot4" class="group-lot">Empty</div>
                            </div>
                            <div class="progress-bar">
                                <div id="progress4" class="progress-fill empty" style="width: 0%"></div>
                                <div id="progressText4" class="progress-text">0%</div>
                            </div>
                            <div id="r12permit" class="gate gate-closed">R12 PERMIT<br>OFF</div>
                        </div>
                    </div>
                </div>
                
                <div class="legend">
                    <div class="legend-item"><div class="legend-color" style="background: #00d4ff;"></div> Lot A</div>
                    <div class="legend-item"><div class="legend-color" style="background: #ff8800;"></div> Lot B</div>
                    <div class="legend-item"><div class="legend-color" style="background: #00ff88;"></div> Lot C</div>
                    <div class="legend-item"><div class="legend-color" style="background: #ff44aa;"></div> Lot D</div>
                </div>
            </div>
            
            <!-- Right Panel: Controls & Log -->
            <div class="right-panel">
                <div class="queue-info" id="queueInfo">
                    Scan barcode to load ‚Üí Group 1
                </div>
                
                <div class="indicators">
                    <div class="indicator">
                        <div id="lightReady" class="light"></div>
                        <span>Ready</span>
                    </div>
                    <div class="indicator">
                        <div id="lightProgress" class="light"></div>
                        <span>Transfer</span>
                    </div>
                    <div class="indicator">
                        <div id="lightComplete" class="light"></div>
                        <span>Complete</span>
                    </div>
                </div>
                
                <div class="controls">
                    <button id="btnScan" class="btn btn-scan" onclick="scanBarcode()">üì± SCAN [1]</button>
                    <button id="btnStart" class="btn btn-start" onclick="startCycle()">‚ñ∂Ô∏è START [3]</button>
                    <button id="btnEstop" class="btn btn-estop" onclick="eStop()">üõë E-STOP [E]</button>
                    <button id="btnReset" class="btn btn-reset" onclick="resetSystem()">üîÑ RESET [R]</button>
                </div>
                
                <div class="keyboard-hint">[1] Scan | [3] Start | [E] Stop | [R] Reset</div>
                
                <div id="log" class="log"></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // SYSTEM STATE
        // ============================================================
        const LOT_COLORS = ['lot-a', 'lot-b', 'lot-c', 'lot-d'];
        const LOT_NAMES = ['LOT-A', 'LOT-B', 'LOT-C', 'LOT-D'];
        let lotCounter = 0;
        
        const state = {
            // System
            CPS_RDY: true,
            E_Stop_Active: false,
            transferring: false,
            
            // Transfer sequence tracking
            transferSequence: [],      // Array of pending transfers
            currentTransferIndex: 0,   // Which transfer is active
            activeTransfer: null,      // Current transfer object
            
            // Groups: {material: 0-100, lot: null or lot name, lotColor: css class}
            groups: [
                { material: 0, lot: null, lotColor: 'empty' },  // Group 1
                { material: 0, lot: null, lotColor: 'empty' },  // Group 2
                { material: 0, lot: null, lotColor: 'empty' },  // Group 3
                { material: 0, lot: null, lotColor: 'empty' }   // Group 4
            ],
            
            // Gates
            gates: [false, false, false],  // Material, Aspirator, R12
            
            // R12
            R12_Permit: false,
            R12_Ready: true
        };
        
        // ============================================================
        // PLC LOGIC
        // ============================================================
        function plcScan() {
            const s = state;
            
            // System Ready
            s.CPS_RDY = !s.E_Stop_Active;
            
            // R12 Permit - process when Group 4 has material AND transfer to G4 is complete
            const hasG4Material = s.groups[3].material > 0;
            const notTransferringToG4 = !s.gates[2]; // Gate 2 is R12 gate (G3‚ÜíG4)
            s.R12_Permit = hasG4Material && notTransferringToG4 && s.R12_Ready && s.CPS_RDY;
            
            // Auto-process R12 (only after transfer is complete)
            if (s.R12_Permit && s.groups[3].material > 0) {
                s.groups[3].material -= 3;
                if (s.groups[3].material <= 0) {
                    s.groups[3].material = 0;
                    const completedLot = s.groups[3].lot;
                    s.groups[3].lot = null;
                    s.groups[3].lotColor = 'empty';
                    if (completedLot) {
                        addLog(`‚úÖ ${completedLot} COMPLETE - Processed by R12`);
                    }
                }
            }
            
            // Sequential Transfer logic
            if (s.transferring && s.activeTransfer) {
                const t = s.activeTransfer;
                const fromGroup = s.groups[t.from];
                const toGroup = s.groups[t.to];
                
                if (fromGroup.material > 0) {
                    const transfer = Math.min(5, fromGroup.material);
                    fromGroup.material -= transfer;
                    toGroup.material += transfer;
                    
                    // Cap at 100%
                    if (toGroup.material > 100) toGroup.material = 100;
                    
                    // Transfer lot info on first transfer
                    if (!toGroup.lot) {
                        toGroup.lot = fromGroup.lot;
                        toGroup.lotColor = fromGroup.lotColor;
                    }
                    
                    // Check if this transfer is complete
                    if (fromGroup.material <= 0) {
                        fromGroup.material = 0;
                        toGroup.material = 100; // Ensure destination is exactly 100%
                        fromGroup.lot = null;
                        fromGroup.lotColor = 'empty';
                        s.gates[t.gate] = false;
                        addLog(`üì¶ ${t.lot}: Group ${t.from+1} ‚Üí Group ${t.to+1} ‚úì`);
                        
                        // Move to next transfer in sequence
                        s.currentTransferIndex++;
                        s.activeTransfer = null;
                        
                        // Small delay then start next transfer
                        setTimeout(() => {
                            startNextTransfer();
                        }, 200);
                    }
                }
            }
            
            updateUI();
        }
        
        // ============================================================
        // USER ACTIONS
        // ============================================================
        function scanBarcode() {
            const s = state;
            if (s.E_Stop_Active) return;
            
            // Can only scan if Group 1 is empty
            if (s.groups[0].material > 0) {
                addLog("‚ö†Ô∏è Cannot scan - Group 1 still has material");
                return;
            }
            
            // Create new lot
            const lotName = LOT_NAMES[lotCounter % 4];
            const lotColor = LOT_COLORS[lotCounter % 4];
            lotCounter++;
            
            // Load material into Group 1
            s.groups[0].material = 100;
            s.groups[0].lot = lotName;
            s.groups[0].lotColor = lotColor;
            
            addLog(`üì± Scanned & Loaded: ${lotName} (100%) in Group 1`);
        }
        
        function startCycle() {
            const s = state;
            if (s.E_Stop_Active) return;
            if (s.transferring) {
                addLog("‚ö†Ô∏è Transfer in progress - wait...");
                return;
            }
            
            // PULL system - Start from back, move ALL materials one step forward
            // But each gate only opens if destination is empty
            // Sequence: Gate2 first, then Gate1, then Gate0
            
            let gatesOpened = 0;
            let pendingGates = [];
            
            // Check all possible transfers (from back to front)
            // Gate 2: Group 3 ‚Üí Group 4
            if (s.groups[2].material > 0 && s.groups[3].material === 0) {
                pendingGates.push({ gate: 2, from: 2, to: 3, lot: s.groups[2].lot });
            }
            // Gate 1: Group 2 ‚Üí Group 3 (will be empty after gate 2 moves)
            if (s.groups[1].material > 0 && (s.groups[2].material === 0 || pendingGates.find(g => g.gate === 2))) {
                pendingGates.push({ gate: 1, from: 1, to: 2, lot: s.groups[1].lot });
            }
            // Gate 0: Group 1 ‚Üí Group 2 (will be empty after gate 1 moves)
            if (s.groups[0].material > 0 && (s.groups[1].material === 0 || pendingGates.find(g => g.gate === 1))) {
                pendingGates.push({ gate: 0, from: 0, to: 1, lot: s.groups[0].lot });
            }
            
            if (pendingGates.length === 0) {
                if (s.groups[0].material === 0 && s.groups[1].material === 0 && 
                    s.groups[2].material === 0 && s.groups[3].material === 0) {
                    addLog("‚ö†Ô∏è System empty - scan a barcode first");
                } else {
                    addLog("‚ö†Ô∏è Waiting - R12 (Group 4) still processing");
                }
                return;
            }
            
            // Start sequential transfer - all gates that can open
            s.transferSequence = pendingGates;
            s.currentTransferIndex = 0;
            s.transferring = true;
            
            // Log what will happen
            const movements = pendingGates.map(g => `${g.lot}: G${g.from+1}‚ÜíG${g.to+1}`).join(', ');
            addLog(`‚ñ∂Ô∏è START: ${movements}`);
            
            // Open first gate (from back)
            startNextTransfer();
        }
        
        function startNextTransfer() {
            const s = state;
            if (s.currentTransferIndex >= s.transferSequence.length) {
                // All transfers complete
                s.transferring = false;
                s.transferSequence = [];
                return;
            }
            
            const transfer = s.transferSequence[s.currentTransferIndex];
            s.gates[transfer.gate] = true;
            s.activeTransfer = transfer;
        }
        
        function eStop() {
            state.E_Stop_Active = true;
            state.gates = [false, false, false];
            state.transferring = false;
            addLog("üõë E-STOP ACTIVATED!");
        }
        
        function resetSystem() {
            state.E_Stop_Active = false;
            state.transferring = false;
            state.gates = [false, false, false];
            state.groups = [
                { material: 0, lot: null, lotColor: 'empty' },
                { material: 0, lot: null, lotColor: 'empty' },
                { material: 0, lot: null, lotColor: 'empty' },
                { material: 0, lot: null, lotColor: 'empty' }
            ];
            lotCounter = 0;
            addLog("üîÑ System Reset");
        }
        
        // ============================================================
        // UI UPDATE
        // ============================================================
        function updateUI() {
            const s = state;
            
            // Status bar
            document.getElementById('sysStatus').textContent = s.CPS_RDY ? 'READY' : 'NOT READY';
            document.getElementById('sysStatus').className = 'status-value ' + (s.CPS_RDY ? 'status-ok' : 'status-error');
            
            document.getElementById('estopStatus').textContent = s.E_Stop_Active ? 'ACTIVE!' : 'OK';
            document.getElementById('estopStatus').className = 'status-value ' + (s.E_Stop_Active ? 'status-error' : 'status-ok');
            
            // Count lots in system
            const lotsInSystem = s.groups.filter(g => g.lot !== null).length;
            document.getElementById('lotsCount').textContent = lotsInSystem;
            
            // Next lot
            const nextLotNum = lotCounter % 4;
            document.getElementById('nextLot').textContent = s.groups[0].material === 0 ? LOT_NAMES[nextLotNum] : 'WAIT';
            
            // Progress bars and lots
            for (let i = 0; i < 4; i++) {
                const g = s.groups[i];
                const progressEl = document.getElementById('progress' + (i+1));
                progressEl.style.width = g.material + '%';
                progressEl.className = 'progress-fill ' + g.lotColor;
                document.getElementById('progressText' + (i+1)).textContent = Math.round(g.material) + '%';
                document.getElementById('lot' + (i+1)).textContent = g.lot || 'Empty';
            }
            
            // Gates
            updateGate('gate1', s.gates[0], 'MAT GATE');
            updateGate('gate2', s.gates[1], 'ASP GATE');
            updateGate('gate3', s.gates[2], 'R12 GATE');
            
            // R12 Permit
            const r12El = document.getElementById('r12permit');
            r12El.className = 'gate ' + (s.R12_Permit ? 'gate-open' : 'gate-closed');
            r12El.innerHTML = 'R12 PERMIT<br>' + (s.R12_Permit ? 'ON' : 'OFF');
            
            // Lights
            document.getElementById('lightReady').className = 'light ' + 
                (s.CPS_RDY && s.groups[0].material === 0 && !s.transferring ? 'light-green' : '');
            document.getElementById('lightProgress').className = 'light ' + 
                (s.transferring ? 'light-yellow' : '');
            document.getElementById('lightComplete').className = 'light ' + 
                (lotsInSystem === 0 && !s.transferring ? 'light-blue' : '');
            
            // Queue info
            let queueText = '';
            if (s.E_Stop_Active) {
                queueText = 'üõë E-STOP ACTIVE - Press Reset';
            } else if (s.transferring) {
                queueText = '‚è≥ Transfer in progress...';
            } else if (s.groups[0].material === 0) {
                queueText = 'üì± Ready to scan new barcode (Group 1 empty)';
            } else {
                queueText = '‚ñ∂Ô∏è Press START to move material forward';
            }
            document.getElementById('queueInfo').textContent = queueText;
        }
        
        function updateGate(id, isOpen, name) {
            const el = document.getElementById(id);
            el.className = 'gate ' + (isOpen ? 'gate-open' : 'gate-closed');
            el.innerHTML = name + '<br>' + (isOpen ? 'OPEN' : 'CLOSED');
        }
        
        function addLog(message) {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            log.innerHTML = `<div class="log-entry"><span class="log-time">[${time}]</span> ${message}</div>` + log.innerHTML;
        }
        
        // ============================================================
        // KEYBOARD CONTROLS
        // ============================================================
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case '1': scanBarcode(); break;
                case '3': startCycle(); break;
                case 'e': case 'E': eStop(); break;
                case 'r': case 'R': resetSystem(); break;
            }
        });
        
        // ============================================================
        // MAIN LOOP
        // ============================================================
        addLog("üåΩ CPS-001 Simulator Started - Version 3.0");
        addLog("üì± Press [1] to scan barcode and load material");
        setInterval(plcScan, 100);
    </script>
</body>
</html>
